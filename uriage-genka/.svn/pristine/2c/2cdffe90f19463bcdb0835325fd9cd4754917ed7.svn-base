<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="stylesheet" type="text/css" href="${f:url('/css/global.css')}"></link>

<style type="text/css">
div.hide-input-form{padding-left:15px;}
div.input-form{
	background-color:#f8e58c;
	width:100%;
	left:0;
	padding:5px 30px;
}
div.input-form table{background-color: transparent; border: none; padding-top: 5px;}
div.input-form th{width: 150px;}
div.input-form td{width: 150px;}
div.input-form font{font-weight:bold;}
input[type="text"]{width:100%;}
div.list-header{position: fixed; z-index: 9999; width:2000px;}
div.list-body{position: absolute; width: 2000px;}
table.theme-list{
	table-layout: fixed;
	border-collapse: collapse;
	border: solid thin black;
}
.theme-no{width: 100px;}
.theme-group{width: 100px;}
.name{width: 300px;}
.other{width: 50px}
.limited-auth{width: 50px}
.date{width: 100px;}
.money{width: 100px;}
.percentage{width: 75px;}
</style>

<script type="text/javascript" src="${f:url('/javascript/checkDatePattern.js')}"></script>
<script type="text/javascript" src="${f:url('/javascript/jquery-3.1.1.min.js')}"></script>

<script type="text/javascript">
function executeClear(){

	var input = document.forms["input"];
	input.themeNo.value = '';
	input.themeGroup.value = '';
	input.naiyoKubun.value = '';
	input.uketsukeDate.value = '';
	input.iraiDate.value = '';
	input.nouki.value = '';
	input.jutyuKingaku.value = '';
	input.keikakuGenkaPar.value = '';
	input.torihikisakiCode.value = '';
	input.tantouBumon.value = '';
	input.uriageMonthKubun.value = '';
	input.notesUriageMonthKubun.value = '';
	input.uriageYearMonth.value = '';
	input.themeName.value = '';
	input.shortThemeName.value = '';

	if(orgRow!=null){
		if(orgRow % 2 == 0)document.getElementById(orgRow).className='row1';
		else document.getElementById(orgRow).className='row2';
	}
	//window.alert('入力フォームをクリアしました。');
	return false;
}

function checkInsert(){
	var input = document.forms["input"];
	if(input.themeNo.value==''){
		window.alert('テーマNOは必須です。');
		return false;
	}
	if(input.themeGroup.value==''){
		window.alert('テーマ親番は必須です。');
		return false;
	}
	if(input.themeName.value==''){
		window.alert('テーマ名は必須です。');
		return false;
	}
	return confirm('入力した内容で新規作成します');
}

function checkUpdate(){
	if(checkQuote() == false)return false;
	else return window.confirm('更新して良いですか？');
}

function checkDelete(){
	if(checkQuote() == false)return false;
	else return window.confirm('削除して良いですか？');
}

function checkQuote(){
	if(document.forms["input"].themeNo.value == ''){
		window.alert('対象が選択されていません');
		return false;
	} else return true;
}

function executeQuote(obj){

	var input = document.forms["input"];
	input.themeNo.value = obj.form.themeNo.value;
	input.themeGroup.value = obj.form.themeGroup.value;
	input.naiyoKubun.value = obj.form.naiyoKubun.value;
	input.uketsukeDate.value = obj.form.uketsukeDate.value;
	input.iraiDate.value = obj.form.iraiDate.value;
	input.nouki.value = obj.form.nouki.value;
//受注額のみ3桁区切り数値に変換
	input.jutyuKingaku.value = Number(obj.form.jutyuKingaku.value).toLocaleString();
	input.keikakuGenkaPar.value = obj.form.keikakuGenkaPar.value;
	input.torihikisakiCode.value = obj.form.torihikisakiCode.value;
	input.tantouBumon.value = obj.form.tantouBumon.value;
	input.uriageMonthKubun.value = obj.form.uriageMonthKubun.value;
	input.notesUriageMonthKubun.value = obj.form.notesUriageMonthKubun.value;
	input.uriageYearMonth.value = obj.form.uriageYearMonth.value;
	input.themeName.value = obj.form.themeName.value;
	input.shortThemeName.value = obj.form.shortThemeName.value;
//	console.log("quote successful");

	//window.alert('入力フォームに値を転記しました。');
	return false;
}

//もとのスタイルをorgRowに保存して、selectedに変える。
//色替え処理は色々スタイルをいじった後、最後に行いたい処理なので、
//背景色のみを変える処理でも良いかもしれない。
//引数のrowはリスト<th>タグのidにインデックスを設定することで利用可能。
//row1はリストの偶数行、row2は奇数行、selectedは選択中の行のクラス。
var orgRow;
function changeColor(row){
	if(orgRow!=null){
		if(orgRow % 2 == 0)document.getElementById(orgRow).className='row1';
		else document.getElementById(orgRow).className='row2';
	}
	orgRow = row;
	document.getElementById(row).className='selected';
}

//テーマNOの検証を行う。フォーカスが外れた時（onblur）に使用する。
//テーマNOにふさわしい文字列でない場合、入力を空白に戻す。
//また、正しい値が入力されたときテーマ親番の自動採番を行う。
function checkThemeNo(){
	str = document.forms["input"].themeNo.value;
	if(str == '')return;
	if(str.match(/^[0-9]{9}$/)){
		str = str.substring(0,5)+'-'+str.substring(5,9);
		document.forms["input"].themeNo.value = str;
	}
	if(str.match(/^[0-9]{5}-[0-9]{4}$/)){
	//テーマ親番の自動採番
		if(document.forms["input"].themeGroup.value==''){
			document.forms["input"].themeGroup.value = str.substring(0,9)
		}
	}else{
		window.alert('テーマNOに相応しくありません。入力し直して下さい。');
		document.forms["input"].themeNo.value = '';
		document.forms["input"].themeNo.focus();
	}
}

function checkThemeGroup(){
	str = document.forms["input"].themeGroup.value;
	if(str == '')return;
	if(str.match(/^[0-9]{8}$/)){
		str = str.substring(0,5)+'-'+str.substring(5,8);
		document.forms["input"].themeGroup.value = str;
	}
	if(str.match(/[0-9]{5}-[0-9]{3}/))return;

	window.alert('テーマ親番に相応しくありません。入力し直して下さい。');
	document.forms["input"].themeGroup.value = '';
	document.forms["input"].themeGroup.focus();
}

document.onkeydown = KeyEvent;
function KeyEvent(e){
    var pressKey=event.keyCode;
    if(pressKey == 13) {
	return false;
    }
}

function checkMoney(obj){
	str = obj.value;
	if(str=='')return;
	number = Number(str);
	if(isInteger(number)==true && number > 0){
		obj.value=number.toLocaleString();
		return;
	}
	window.alert('金額は自然数でなければいけません。入力し直して下さい。');
	obj.value='';

	function isInteger(x) {
	    return Math.round(x) === x;
	}
/*
	 > isInteger(1)
	true
	> isInteger(0)
	true
	> isInteger(1.111)
	false
	> isInteger("1")
	false
	> isInteger("")
	false
	> isInteger(null)
	false
	> isInteger(NaN)
	false
	> isInteger(undefined)
	false
 */
 }

function checkParcentage(obj){
	str = obj.value;
	if(str=='')return;
	if(str.match(/^[0-9]{2}.[0-9]$/))return;
	number = Number(str);
	if(isInteger(number)==true && (number>=0 && number<=100)){
		obj.value = number.toFixed(1);
		return;
	}
	window.alert('百分率でなければいけません。入力し直して下さい。\n【受け付ける数値例】30,100,65.5');
	obj.value='';

	function isInteger(x) {
	    return Math.round(x) === x;
	}
}

function hideDiv(divId, obj){
	if(obj.value=='非表示'){
		obj.value='表示';
		document.getElementById(divId).style.display='none';
	}else{
		obj.value='非表示';
		document.getElementById(divId).style.display='block';
	}
	initializeUnfixedHeight();
}

function initializeUnfixedHeight(){
	if(${empty themeInsert}){
		console.log('no authorization');
	}

	$('div.fixed').css('top', $('div.header').height());
	$('div.list-header').css('top', $('div.header').height()+$('div.fixed').height());
	$('div.list-body').css('top', $('div.header').height()+ $('div.fixed').height()+ $('div.list-header').height());
}

//var listHeader = $('div#list-header');
window.addEventListener('scroll', _hangleScroll, false);
function _hangleScroll(){
	$('div#list-header').css('left',  - window.scrollX + 8);
	//console.log($('div#list-header').css('left'));
}

//list-bodyの<td class="keyClass">を順次チェックして、newInsertまたはnewUpdateに該当するものがあったら列の色を変える。
//keyClassクラスはその列で一意のクラスでなければならない。text()で複数の要素をまとめて取り出してしまうため。
//対象が複数であっても問題なく色が変わる。ただし対象は列ごと。
function changeExecuteRowColor(keyClass){
	$('.list-body tr').each(function(){
		//keyClass = 'theme-no';
		//console.log('check');
		if($.trim($(this).children('td.'+keyClass).text()) == '${newInsert}'){
			$(this).css('border','solid 2px red');//2px以上にすると、別のテーブルのbordarに影響が出る。謎。
		}
		else if($.trim($(this).children('td.'+keyClass).text()) == '${newUpdate}'){
			$(this).css('border','solid 2px aqua');
		}
	});
}

</script>
<title>${pageName}</title>
</head>
<body onload="initializeUnfixedHeight()">

<div class="header" id="header">
${sysName} / ${pageName}
</div>

<div class="fixed" id="fixed">

<c:if test="${!empty errMessage}">
	<div class="error">
	${errMessage}
	</div>
</c:if>

<html:errors/>

<c:if test="${!empty sysMessage}">
	<div class="message">
	${sysMessage}
	</div>
</c:if>
</div>

<div id="search-form" style="padding-top: 24px;">
<s:form>
<table border="1" >
	<tr>
		<td>年度</td>
		<td><html:select property="searchNendo" value="${searchNendo }">
			<c:forEach var="nl" items="${nendoList }">
				<html:option value="${nl }">${nl }</html:option>
			</c:forEach>
		</html:select></td>
		<td></td>
		<td>顧客名</td>
		<td colspan="2"><html:text property="searchKokyakuName" value="${f:h(searchKokyakuName)}"></html:text></td>
		<td></td>
		<td>ソート</td>
<%--
		<td><input type="radio" name="searchSort" value="nomal">通常</td>
		<td><input type="radio" name="searchSort" value="themeNo">テーマNO</td>
--%>
		<td><html:radio property="searchSort" value="normal" />通常</td>
		<td><html:radio property="searchSort" value="themeNo" />テーマNO</td>
		<td></td>
		<td></td>
		<td></td>
	</tr>
	<tr>
		<td>案件名</td>
		<td colspan="5"><html:text property="searchAnkenName" value="${f:h(searchAnkenName) }"></html:text></td>
		<td></td>
		<td>受注品名</td>
		<td colspan="5"><html:text property="searchJutyuName" value="${f:h(searchJutyuName) }"></html:text></td>
	</tr>
	<tr>
		<td>確度</td>
		<c:forEach var="kl" items="${kakudoList }">
			<td><html:checkbox  property="searchKakudoList" value="${kl.codeId }" />${kl.codeName }</td>
		</c:forEach>
	</tr>
	<tr>
		<td>発注タイプ</td>
		<c:forEach var="htl" items="${hattyuTypeList }">
			<td><html:multibox property="searchHattyuTypeList" value="${htl.codeId }" />${htl.codeName }</td>
		</c:forEach>
	</tr>

	<tr>
		<td>担当</td>
		<c:forEach var="el" items="${eigyoList }">
			<td><html:multibox property="searchEigyoList" value="${el.empNo }" />${el.shortEmpName }</td>
		</c:forEach>
		<td colspan="4"></td>
	</tr>
		<td>特殊</td>
		<c:forEach var="ccl" items="${conditionCodeList }">
			<td><html:multibox property="searchConditionCodeList" value="${ccl.codeId }" />${ccl.codeName }</td>
		</c:forEach>
		<td></td>
		<td></td>
	</tr>
</table>
<html:submit property="search" value="検索"></html:submit>
</s:form>
</div>

<div class="list" style="width: 7500px;">
<table id="list-body">
	<tr>
		<th>年度</th>
		<th>顧客名</th>
		<th>案　件　名</th>
		<th>受注品名</th>
		<th>開発G</th>
		<th>担当</th>
		<th>発注タイプ</th>
		<th>発注見込時期</th>
		<th>発注日</th>
		<th>検収日</th>
		<th>状況</th>
		<th>テーマ親番</th>
		<th>テーマNO</th>
		<th>受注額(円)</th>
		<th>売上計</th>
		<th>４月</th>
		<th>５月</th>
		<th>６月</th>
		<th>７月</th>
		<th>８月</th>
		<th>９月</th>
		<th>上期計</th>
		<th>１０月</th>
		<th>１１月</th>
		<th>１２月</th>
		<th>１月</th>
		<th>２月</th>
		<th>３月</th>
		<th>下期計</th>
		<th>当年度計</th>
		<th>４月</th>
		<th>５月</th>
		<th>６月</th>
		<th>７月</th>
		<th>８月</th>
		<th>９月</th>
		<th>上期計</th>
		<th>１０月</th>
		<th>１１月</th>
		<th>１２月</th>
		<th>１月</th>
		<th>２月</th>
		<th>３月</th>
		<th>下期計</th>
		<th>次年度計</th>
		<th>翌々年度移行売上計画</th>
		<th>備考</th>

	</tr>
	<c:forEach items="${ukList}" var="e" varStatus="s">
		<tr class="${s.index %2 == 0 ? 'row1' : 'row2'}" id="${s.index}">
				<c:if test="${!empty ukUpdate}">
					<td id="${s.index}X1" class="limited-auth"><input type="button" value="選択" onclick="changeColor(${s.index});executeQuote(this);" class="select" /></td>
				</c:if>
				<td id="${s.index}X2" class="nendo" style="text-align: center;">
					${f:h(e.nendo) }
				</td>
				<td id="${s.index}X3" class="kokyaku-name" style="text-align: left; padding-left: 5px;">
					${f:h(e.kokyakuInitial)}  ${f:h(e.kokyakuName)}
				</td>
				<td id="${s.index}X4" class="anken-name" style="text-align: left; padding-left: 5px;">
					${f:h(e.ankenName)}
				</td>
				<td id="${s.index}X5" class="jutyu-name" style="text-align: left; padding-left: 5px;">
					${f:h(e.jutyuName)}
				</td>
				<td id="${s.index}X6" class="short-emp-name" style="text-align: center;">
					${f:h(e.kaihatsuGroupHeadName)}
				</td>
				<td id="${s.index}X7" class="short-emp-name" style="text-align: center;">
					${f:h(e.eigyoName)}
				</td>
				<td id="${s.index}X8" class="hattyu-type" style="text-align: center;">
					${f:h(e.hattyuTypeName)}
				</td>
				<td id="${s.index}X10" class="date" style="text-align: right; padding-right: 5px;">
					${f:h(e.hattyuMikomiDate)}
				</td>
				<td id="${s.index}X11" class="date" style="text-align: right; padding-right: 5px;">
					${f:h(e.hattyuDate)}
				</td>
				<td id="${s.index}X12" class="date" style="text-align: right; padding-right: 5px;">
					${f:h(e.kensyuDate)}
				</td>
				<td id="${s.index}X13" class="jokyo" style="text-align: center;">
					${f:h(e.kakudoName)}
				</td>
				<td id="${s.index}X14" class="theme-no" style="text-align: center;">
					${f:h(e.themeNo)}
				</td>
				<td id="${s.index}X15" class="theme-group" style="text-align: center;">
					${f:h(e.themeGroup)}
				</td>
				<td id="${s.index}X16" class="money" style="text-align: right; padding-right: 5px;">
					¥ <fmt:formatNumber value="${f:h(e.jutyugaku)}" />
				</td>
				<td id="${s.index}X17" class="money" style="text-align: right; padding-right: 5px;">
				</td>

				<c:if test="${!empty e.tounendoApr}">
					<td id="${s.index}X18" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoApr)}" />
					</td>
					<td id="${s.index}X19" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoMay)}" />
					</td>
					<td id="${s.index}X20" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoJun)}" />
					</td>
					<td id="${s.index}X21" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoJul)}" />
					</td>
					<td id="${s.index}X22" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoAug)}" />
					</td>
					<td id="${s.index}X23" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoSep)}" />
					</td>
					<td id="${s.index}X24" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoKamiki)}" />
					</td>
					<td id="${s.index}X25" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoOct)}" />
					</td>
					<td id="${s.index}X26" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoNov)}" />
					</td>
					<td id="${s.index}X27" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoDec)}" />
					</td>
					<td id="${s.index}X28" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoJan)}" />
					</td>
					<td id="${s.index}X29" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoFeb)}" />
					</td>
					<td id="${s.index}X30" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoMar)}" />
					</td>
					<td id="${s.index}X31" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoShimoki)}" />
					</td>
					<td id="${s.index}X32" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.tounendoTotal)}" />
					</td>

				</c:if>
				<c:if test="${empty e.tounendoApr}">
					<td colspan="15"></td>
				</c:if>

				<c:if test="${!empty e.jinendoApr}">
					<td id="${s.index}X33" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoApr)}" />
					</td>
					<td id="${s.index}X34" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoMay)}" />
					</td>
					<td id="${s.index}X35" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoJun)}" />
					</td>
					<td id="${s.index}X36" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoJul)}" />
					</td>
					<td id="${s.index}X37" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoAug)}" />
					</td>
					<td id="${s.index}X38" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoSep)}" />
					</td>
					<td id="${s.index}X39" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoKamiki)}" />
					</td>
					<td id="${s.index}X40" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoOct)}" />
					</td>
					<td id="${s.index}X41" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoNov)}" />
					</td>
					<td id="${s.index}X42" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoDec)}" />
					</td>
					<td id="${s.index}X43" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoJan)}" />
					</td>
					<td id="${s.index}X44" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoFeb)}" />
					</td>
					<td id="${s.index}X45" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoMar)}" />
					</td>
					<td id="${s.index}X46" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoShimoki)}" />
					</td>
					<td id="${s.index}X47" class="money" style="text-align: right; padding-right: 5px;">
						¥ <fmt:formatNumber value="${f:h(e.jinendoTotal)}" />
					</td>
				</c:if>
				<c:if test="${empty e.jinendoApr}">
					<td colspan="15"></td>
				</c:if>

				<td id="${s.index}X48" class="money" style="text-align: right; padding-right: 5px;">
					¥ <fmt:formatNumber value="${f:h(e.ukYokuyoku)}" />
				</td>
				<td id="${s.index}X49" class="notes" style="text-align: left; padding-left: 5px;">
					${f:h(e.notes)}
				</td>

		</tr>
	</c:forEach>
</table>
</div>
</body>
</html>